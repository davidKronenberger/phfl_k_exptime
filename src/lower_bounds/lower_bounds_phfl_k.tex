%%
%% Author: DKron
%% 17.08.2018
%%

\section{Lower Bound of PHFL$^k$}\label{sec:lowerBoundOfPhfl}

As mentioned in the introduction of this chapter we can show that the lower bound of PHFL$^k$ is \exptime{$k$} by
make a detour over HO(LFP)$^{k+1}$. This and following ideas are oriented on~\cite{lange2014capturing} where was
shown that PHFL$^1$ captures \exptime{$1$}. The first thing we will see is that it was proven that HO(LFP)$^{k +
1}$ coincides with $k$-fold exponential time over finite and ordered structures. To use this we have to encode the
bisimulation invariant fragment of HO$^{k+1}$ into PHFL$^k$. For this we first define an abbreviation for the HO(LFP)
formulas that uses the LFP operator. Next, we define a function that uses this abbreviation and these of
Section~\ref{sec:existential_quantifiers_in_phfl} to map a HO(LFP)$^{k+1}$ formula to a PHFL$^k$ formula. Finally, we
show that the semantics of the HO(LFP)$^{k+1}$ formula coincides with the transformed PHFL$^k$ formula.

\begin{theorem}{\cite{freireMartins2011descriptive}}\label{theorem:hoLfpEqualsExptime}
    For all $k \geq 1$, HO(LFP)$^{k + 1} = k$-EXPTIME over finite and ordered structures.
\end{theorem}

The proof follows the idea to encode the run of a $k$-EXPTIME Turing Machine $M$ by a formula $\phi$ of HO(LFP)$^{k +
1}$ in this way such that $M$ accepts $\mathcal{A}$ iff $\mathcal{A} \models \phi$. On the other hand each HO(LFP)$^{k +
1}$ formula $\phi$ can be evaluated by a $k$-EXPTIME Turing Machine $M_\phi$.

Because Theorem~\ref{theorem:hoLfpEqualsExptime} holds it is also possible to prove that the lower bound of PHFL$^k$
is in \exptime{$k$} by encoding the bisimulation invariant fragment of HO(LFP)$^{k + 1}$ into PHFL$^k$. To encode the
bisimulation invariant fragment of HO(LFP)$^{k + 1}$ into PHFL$^k$ we have to define a function that transforms a HO
(LFP)$^{k + 1}$ formula to a PHFL$^k$ formula. Note that the types and variables of an HO formula have to be also
transformed. See Section~\ref{sec:existential_quantifiers_in_phfl} for further details.

Before we give the definition of the transforming function, we define a PHFL formula for HO formulas that uses the
LFP operator.

\begin{definition}
    For any HO variable $X$ of HO type $\tau = (\tau', \dots, \tau')$ where $\tau' \neq \odot$ and any HO variables
    $x_1, v_1, \dots, $ $x_n, v_n$ HO type $\tau'$ and any PHFL formula $\Phi$ let
    \[LFP^\tau X.\,\Phi \coloneqq (\dotsb (\mu (X \colon T(\tau)).\,\Phi(X, x_1, \dots, x_n))(v_1))\dotsb)(v_n).\]
    In case of $\tau = (\odot, \dots, \odot)$ and $v_1, \dots, v_n$ have index $i_1, \dots, i_n$ respectively let
    \[LFP^{\tau} X.\,\Phi \coloneqq \{(i_1, \dots, i_n, n + 1, \dots, d)\} \mu (X \colon \bullet).\,\Phi(X).\]
\end{definition}

Remember that we have defined the signatures of HO(LFP) relational. Because we are working on LTS, the relations in
the signatures have either arity one or two. Relations with arity one represents the propostions and those with arity
two the actions of an LTS. Now we are able to define the function to translate a bisimulation invariant HO(LFP)$^{k+1}$
formula to a PHFL$^k$.

\begin{definition}
    \label{definition:lower_bounds_phfl_formula_function}
    Let $F$ be the function that maps a bisimulation invariant HO(LFP)$^{k+1}$ formula to a PHFL$^k$ formula defined
    inductive on bisimulation invariant HO(LFP)$^{k+1}$ formula $\Phi$ as follows:
    \begin{align*}
        F(p(x_i)) \coloneqq &\, p_i \\
        F(a(x_i, x_j)) \coloneqq &\, \langle a \rangle_i \{(i, j, 3, \dots, d)\} \Phi_\sim \\
        F(\Phi \vee \Psi) \coloneqq &\, F(\Phi) \vee F(\Psi) \\
        F(\neg \Phi) \coloneqq &\, \neg F(\Phi) \\
        F(\exists (x_i \colon \odot).\,\Phi) \coloneqq &\, \exists_i F(\Phi) \\
        F(\exists (X \colon \tau).\,\Phi) \coloneqq &\, \exists^\tau X.\,F(\Phi(X)) \\
        F([LFP\;\Phi(X, x_1, \dots, x_n)](v_1, \dots, v_n)) \coloneqq &\,LFP^\tau X.\, F(\Phi) \\
        F(X(x_1, \dots, x_n)) \coloneqq &\, (\dots (X(x_1))\dots)(x_n)\\
        F(X(x_{i_1}, \dots, x_{i_n})) \coloneqq &\, \{(i_1, \dots, i_n, n + 1, \dots, d)\}X
    \end{align*}
\end{definition}

\subsection{Variables}\label{subsec:lower_bounds_variables}

After we have encode HO(LFP)$^{k+1}$ syntactically in PHFL$^k$ formulas, the last step is to translate the 
interpretation of variables. As described in Section~\ref{sec:existential_quantifiers_in_phfl} the variables in HO of 
types with order $3$ or higher are not supported in PHFL. Also first-order variables are not supported. For this we 
define a function that maps a given variable mapping for a HO formula to the correct variable mapping for PHFL 
semantics. This function ignores the mapping of first-order variables, maps second-order variables also to sets and 
higher-order variables to the corresponding characteristic function. Note, that the sets of order $2$ in HO have order 
$0$ in PHFL. The first-order variables of an HO formula that are marked as undefined in the following function, can be 
mapped to anything because we do not use them in PHFL directly.

\begin{definition}
    \label{definition:lower_bound_variable_function}
    Let $\Phi$ be a HO(LFP)$^{k+1}$ formula with free variables $x_1, \dots, x_f$ and quantified variables $x_{f+1}, 
    \dots, x_q$. Furthermore, let $s$ be the maximal arity of all second order variables of $\Phi$,  let $\eta$ be a
    variable mapping for $\Phi$ and let $\mathcal{T} = (Q, \Sigma, P, \Delta, v)$ be a reduced LTS, then $\eta_V$ is a 
    variable mapping for a PHFL$^k$ formula with dimension $d = 2 * m + r$, where $m = max({q,
    s})$ and $r$ is the number of states that defines the reduced LTS $\mathcal{T}$, defined as
    \[\eta_V(X)\coloneqq
    \begin{cases}
        \text{undefined}, & \text{if } X \text{ is of type } \odot \\
        A,  & \text{if } X \text{ is of type } (\odot, \dots, \odot)\\
        F, & \text{if } X \text{ is of type } (\tau, \dots, \tau) \text{ and } \tau \neq \odot,
    \end{cases}\]
    where $A \subseteq Q^d$ such that $(q_1, \dots, q_n, q_{n + 1}, \dots, q_d) \in A$ iff $(q_1, \dots, q_n) \in
    \eta(X)$ and $F$ is a function of type $T((\tau, \dots, \tau))$ defined as follows:
    \begin{align*}
        (\dots(F(\eta_V(X_1)))\dots)(\eta_V(X_n)) &= Q^d &\text{ iff } (X_1, \dots, X_n) \in \eta(X)\\
        (\dots(F(\eta_V(X_1)))\dots)(\eta_V(X_n)) &= \emptyset &\text{ iff } (X_1, \dots, X_n)
        \not\in \eta(X)
    \end{align*}
\end{definition}

The following example shows how a set of higher type will be translate to its characteristic function via the
variable mapping $\eta_V$ of Definition~\ref{definition:lower_bound_variable_function}.

\begin{example}
    Let $\mathcal{A}$ be a $\sigma$-structure over universe $\mathcal{U} = \{1, 2, 3\}$, let $X$ be a HO(LFP)$^{k + 1}$
    variable of type $((\odot, \odot), (\odot, \odot))$ mapped through variable mapping $\eta$ to
    \[\eta(X) = \{(\{(1, 1)\}, \{(2, 2)\}), (\{(1, 1), (2, 2)\}, \{(3, 3)\})\},\]
    let $\mathcal{T} = (\mathcal{U}, \Sigma, P, \Delta, v)$ be a reduced LTS and $d$ a dimension of PHFL, then $\eta_V(X)$ is a PHFL$^k$ function of type $\bullet \rightarrow (\bullet \rightarrow \bullet)$ such
    that $\eta_V(X)$ $(\{(1, 1)\}) = f$, $\eta_V(X)(\{(1, 1), (2, $ $2)\}) = g$ and $\eta_V(X)(z) = h$ for $z \in
    \mathcal{U}^d$ and $z \neq \{(1, 1)\}$ and $z \neq \{(1, 1), (2, 2)\}$. $f$, $g$ and $h$ are functions of type $\bullet
    \rightarrow \bullet$ where $f(\{(2, 2)\}) = g(\{(3, 3)\}) = \mathcal{U}^d$ and $f(z) = g(z') = h(z'') = \emptyset$ for $z,
    z', z'' \in \mathcal{U}^d$ and $z \neq \{(2, 2)\}$ and $z' \neq \{(3, 3)\}$.
\end{example}

\subsection{Correctness Proof}\label{subsec:lower_bounds_correctness_lfp}

The last step is to show that the semantics of a given HO(LFP)$^{k+1}$ formula coincides with the semantics of the by function $F$ encoded PHFL$^k$ formula. As mentioned in Section~\ref{sec:lower_bounds_preparation} without loss of generality the statement can be proven by consider only  reduced LTS. 

To make the correctness proof clearer there is one last remark.

\begin{remark}
    It holds for any HO(LFP)$^{k+1}$ formula $\Phi$ that for PHFL$^k$ formula $F(\Phi)$ and some type environment $Gamma$ the type judgment $\Gamma \vdash
    \Phi \colon \tau$ is derivable, where $\tau$ is a PHFL type. This statement
    is easy proved by induction over the structure of formula $\Phi$. 
\end{remark}

Because the type judgement is always derivable we ignore the type environment in the following proof and write just $\llbracket \Phi \rrbracket^\eta_\mathcal{T}$ instead of $\llbracket \Gamma \vdash F(\Phi) \colon \tau \rrbracket^\eta_\mathcal{T}$, where $\Phi$ is a PHFL formula, $eta$ is a variable mapping, $\mathcal{T}$ is an LTS, $\Gamma$ is a type environment and $\tau$ is a PHFL type.

\begin{lemma}
    \label{lemma:ho_lfp_equals_phfl}
    Let $f \geq 1$ and $k \geq 0$. For every bisimulation invariant formula $\Phi$ of HO(LFP)$^{k + 1}$ there is a
    PHFL$^k$ formula $\Psi$ such that $\mathcal{Q}_\Phi^f = \mathcal{Q}_\Psi^f$.
\end{lemma}

\begin{proof}
    This lemma can be proven by showing for all HO(LFP)$^{k+1}$ formulas $\Phi$ with free first-order variables $x_1,
    \dots, x_f$ and quantified first-order variables $x_{f+1}, \dots, x_q$, all reduced LTS $\mathcal{T} = (Q, \Sigma, P,
    \Delta, v)$ with respect to $q_1, \dots, q_r$ and all variable mappings $\eta$ that it holds that $\mathcal{T}, \eta \models \Phi$ iff $\emph{q} =
    (\eta(x_1), \dots, $ $\eta(x_q), q_0, \dots, q_0, q_1, \dots, q_nr$ and $\emph{q} \in \llbracket
   F(\Phi)\rrbracket^{\eta_V}_{\mathcal{T}}$, where $q_0
    \in Q$ is an arbitrary state, $F$ is the formula function of
    Definition~\ref{definition:lower_bounds_phfl_formula_function} and $\eta_V$ the variable mapping of
    Definition~\ref{definition:lower_bound_variable_function}. This statement can be proven by induction over formula
    $\Phi$.
    \begin{compactitem}
        \item In case of $\Phi = p(x_i)$ then $\mathcal{T}, \eta \models \Phi$ holds exactly then if $\eta(x_i) \in
        p^\mathcal{T}$. Translated to the normal LTS definition of $\mathcal{T}$ it is the same as $p \in v(\eta(x_i))$.
        With $F(\Phi) = p_i$ this is exactly
        \begin{align*}
            (\eta(x_1),& \dots, \eta(x_{i-1}), \eta(x_{i}), \eta(x_{i+1}), \dots, \eta(x_q),\\& q_0, \dots, q_0, q_1, \dots, q_r) \in
            \llbracket F(\Phi) \rrbracket^{\eta_V}_\mathcal{T}.
        \end{align*}
        \item In case of $\Phi = a(x_i, x_j)$ then $\mathcal{T}, \eta \models \Phi$ holds exactly then if $(\eta(x_i)
        , \eta(x_j))$ $ \in a^\mathcal{T}$. Translated to the normal LTS definition of $\mathcal{T}$ it is the same as $
        \eta(x_i) \overset{a}{\rightarrow} \eta(x_j)$. Let $g: \{1, 2\} \rightarrow \{i, j\}$ be a function.
        By  definition of the semantics of $\langle a \rangle_i \Phi$ the tuple
        \begin{align*}
            (\eta(x_1),& \dots, \eta(x_{g(1) - 1}), \eta(x_{g(1)}), \eta(x_{g(1)+1}), \dots, \eta(x_{g(2)-1}), \eta
            (x_{g(2)}),\\& \eta(x_{g(2)+1}), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r)
        \end{align*}
        is an element of the semantics of $\langle a \rangle_i \Phi$ if
        \begin{align*}
            (\eta(x_1),& \dots, \eta(x_{g(1) - 1}), q_m, \eta(x_{g(1)+1}), \dots, \eta(x_{g(2)-1}), q_n,\\& \eta(x_{g(2)
            +1}), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r)
        \end{align*}
        is an element of the semantics of $\Phi$ where $\eta(x_i)$ can
        move by an $a$ action to $q_m$ if $g(1) = i$ or to $q_n$ if $g(2) = i$. Because $\eta(x_j)$ is the state that
        have to be reached via an $a$ action from $\eta(x_i)$ we have to check if $q_m = \eta(x_j)$ in case of $g(1)
        = j$ and in case of $g(2) = j$ we have to check if $q_n = \eta(x_i)$. If two states are equal in an LTS is
        similar to check if those states are bisimilar. $\sim$ is given by formula $\Phi_\sim$ of
        Example~\ref{example:phfl_order_0}.
        Because this formula returns those $d$-tuples where the first and second component are bisimilar, we have to
        move the $i$-th and $j$-th component to the first and second component. This is given by $\{(i, j, 3, \dots, d
        )\} \Phi_\sim$. Summarizing all this steps with $F(\Phi) = \langle a \rangle_i \{(i, j, 2, \dots, d)\}
        \Phi_\sim$ it follows
        \begin{align*}
            (\eta(x_1),& \dots, \eta(x_{g(1) - 1}), \eta(x_{g(1)}), \eta(x_{g(1)+1}), \dots, \eta(x_{g(2)-1}), \eta
            (x_{g(2)}),\\& \eta(x_{g(2)+1}), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \in \llbracket F(\Phi) \rrbracket^{\eta_V}_\mathcal{T}
        \end{align*}
        if $(\eta(x_i), \eta(x_j))$ $ \in a^\mathcal{T}$ and
        \begin{align*}
            (\eta(x_1),& \dots, \eta(x_{g(1) - 1}), \eta(x_{g(1)}), \eta(x_{g(1)+1}), \dots, \eta(x_{g(2)-1}), \eta
            (x_{g(2)}),\\& \eta(x_{g(2)+1}), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \not\in \llbracket F(\Phi) \rrbracket^{\eta_V}_\mathcal{T}
        \end{align*}
        if $(\eta(x_i), \eta(x_j))$ $ \not\in a^\mathcal{T}$.

        \item In case of $\Phi = X(x_{i_1}, \dots, x_{i_n})$ where $X$ is a free variable of HO type $(\odot, \dots,
        \odot)$ and $x_{i_1}, \dots, x_{i_n}$ are free first-order variables then $\mathcal{T}, \eta \models \Phi$
        holds exactly then if $(\eta(x_{i_1}), \dots \eta(x_{i_n})) \in \eta(X)$. Because of definition of $\eta_V$ the
        tuple $(\eta(x_{i_1}), \dots \eta(x_{i_n}), \eta(x_{n + 1}), \dots, \eta(x_{q}), q_0, \dots, q_0, q_1, \dots, q_r)$ is in $
        \eta_V(X)$ if $(\eta(x_{i_1}),\dots \eta(x_{i_n})) \in \eta(X)$ and is not in $\eta_V(X)$ otherwise. Because
        the components $i_1, \dots, i_n$ for first-order variables $x_{i_1}, \dots, x_{i_n}$ have not to be $1,
        \dots, n$ respectively, we first move them to this components and check then if
        \[(\eta(x_{i_1}), \dots \eta(x_{i_n}), \eta(x_{n + 1}), \dots, \eta(x_{q}), q_0, \dots, q_0, q_1, \dots, q_r) \in \eta_V(X).\]
        So it holds with $F(\Phi) = {(i_1, \dots, i_n, n+1, \dots, d)}X$ and function $g: \{1, \dots, n\}
        \rightarrow \{i_1, \dots, i_n\}$ that
        \begin{align*}
            (\eta(x_1),& \dots, \eta(x_{g(1)-1}), \eta(x_{g(1)}), \eta(x_{g(1)+1}), \dots \eta(x_{g(2)-1}), \eta
            (x_{g(2)}),\\& \eta(x_{g(2)+1}), \dots, \eta(x_{g(n)-1}), \eta(x_{g(n)}), \eta(x_{g(n)+1}), \dots, \eta
            (x_q),\\& q_0, \dots, q_0, q_1, \dots, q_r) \in \llbracket F(\Phi) \rrbracket^{\eta_V
            }_\mathcal{T}
        \end{align*}
        if $(\eta(x_{i_1}), \dots \eta(x_{i_n})) \in \eta(X)$ and
        \begin{align*}
            (\eta(x_1),& \dots, \eta(x_{g(1)-1}), \eta(x_{g(1)}), \eta(x_{g(1)+1}), \dots \eta(x_{g(2)-1}), \eta
            (x_{g(2)}),\\& \eta(x_{g(2)+1}), \dots, \eta(x_{g(n)-1}), \eta(x_{g(n)}), \eta(x_{g(n)+1}), \dots, \eta
            (x_q),\\& q_0, \dots, q_0, q_1, \dots, q_r) \not\in \llbracket F(\Phi) \rrbracket^{\eta_V
            }_\mathcal{T}
        \end{align*}
        if $(\eta(x_{i_1}), \dots \eta(x_{i_n})) \not\in \eta(X)$.

        \item In case of $\Phi = X(X_1, \dots, X_n)$ where $X$ is a free variable of HO type $(\tau, \dots,
        \tau)$ and $X_1, \dots, X_n$ are free variables of HO type $\tau$ then $\mathcal{T}, \eta \models \Phi$
        holds exactly then if $(\eta(X_1), \dots \eta(X_n)) \in \eta(X)$. Because of definition of $\eta_V$ it follows
        \[(\dotsb(\eta_V(X)(\eta_V(X_1)))\dotsb)(\eta_V(X_n)) = Q^d\]
        if $(\eta(X_1), \dots \eta(X_n)) \in \eta(X)$ and
        \[(\dotsb(\eta_V(X)(\eta_V(X_1)))\dotsb)(\eta_V(X_n)) = \emptyset\]
        if $(\eta(X_1), \dots \eta(X_n)) \not\in \eta(X)$. With $F(\Phi) = (\dotsb (X(X_1))\dotsb)(X_n)$
        it follows
        \[ (\eta(x_1), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \in \llbracket F(\Phi) \rrbracket^{\eta_V}_\mathcal{T} = Q^d.\]
        if $(\eta(X_1), \dots \eta(X_n))\in \eta(X)$ and
        \[ (\eta(x_1), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \not\in \llbracket F(\Phi)
        \rrbracket^{\eta_V}_\mathcal{T} = \emptyset.\]
        if $(\eta(X_1), \dots \eta(X_n)) \not\in \eta(X)$.
    \end{compactitem}
    By induction hypothesis it holds for HO(LFP)$^{k+1}$ formulas $\Psi$ and $\Psi'$ with free first-order variables $x_1, \dots,
    x_f$ and quantified first-order variables $x_{f+1}, \dots, x_q$ that for all reduced LTS $\mathcal{T} = (Q, \Sigma, P, \Delta, v)$ with respect to $q_1, \dots, q_r$ and all variable
    mappings $\eta$ that $\mathcal{T}, \eta \models \Psi$ iff $ (\eta(x_1), \dots, \eta(x_q),$ $ q_0, \dots, q_0, q_1, \dots, q_r) \in
    \llbracket F(\Psi) \rrbracket^{\eta_V}_\mathcal{T}$ and $\mathcal{T}, \eta \models \Psi'$ iff $
    (\eta(x_1), \dots, \eta(x_q), q_0, \dots, $ $q_0, q_1, \dots, q_r) \in \llbracket F(\Psi')\rrbracket^{\eta_V
    }_\mathcal{T}$.
    \begin{compactitem}
        \item In case of $\Phi = \neg \Psi$ it follows that $\mathcal{T}, \eta \models \Phi$ exactly then if
        $\mathcal{T}, \eta \not\models \Psi$. By induction hypothesis that is exactly then the case when
        \[ (\eta(x_1), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \not\in \llbracket F(\Psi) \rrbracket^{\eta_V}_\mathcal{T}.\]
        This is exactly the case if
        \[ (\eta(x_1), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \in Q^d \setminus \llbracket F(\Psi) \rrbracket^{\eta_V}_\mathcal{T}.\]
        And this is exactly the semantics of $F(\Phi) = \neg F(\Psi)$.

        \item In case of $\Phi = \Psi \vee \Psi'$ it follows that $\mathcal{T}, \eta \models \Phi$ exactly then if
        $\mathcal{T}, \eta \models \Psi$ or $\mathcal{T}, \eta \models \Psi'$. By induction hypothesis that is
        exactly then the case when
        \[(\eta(x_1), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \in \llbracket F
        (\Psi) \rrbracket^{\eta_V}_\mathcal{T}\]
        or
        \[(\eta(x_1), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \in \llbracket F
        (\Psi') \rrbracket^{\eta_V}_\mathcal{T}.\]
        Because $\sqcup_{\bullet} = \cup$ this can be combined to
        \[(\eta(x_1), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \in \llbracket F
        (\Psi) \rrbracket^{\eta_V}_\mathcal{T} \sqcup_\bullet \llbracket F
        (\Psi') \rrbracket^{\eta_V}_\mathcal{T},\]
        what is the semantics of $F(\Phi) = F(\Psi) \vee F(\Psi')$.

        \item In case of $\Phi = \exists (x_i\colon \odot).\,\Psi$ it follows that $\mathcal{T}, \eta \models \Phi$ iff
        there exists  $\mathcal{X} \in Q$ with $\mathcal{T}, \eta[x_i \rightarrow \mathcal{X}] \models \Psi$. Because
        $x_i$ is a free variable in $\Psi$ it follows by induction hypothesis that $\mathcal{T}, \eta[x_i
        \rightarrow \mathcal{X}] \models \Psi$ is exactly the case when
        \begin{align*}
            (\eta(x_1),& \dots, \eta(x_{i-1}), \eta(x_i), \eta(x_{i+1}), \dots, \eta(x_{q+1}),\\& q_0, \dots, q_0, q_1, \dots, q_r) \in
            \llbracket \Gamma \vdash F(\Psi) \rrbracket^{\eta_V}_\mathcal{T}.
        \end{align*}
        Because $x_i$ is bounded in $\Phi$ we have to replace the $i$-th component by one of the free. This is
        denoted by $\overset{f}{\underset{j=1}{\bigvee}} \{(1, \dots, i-1, j, i+1, \dots, d)\}$.
        Because of bisimilarity all states of $\mathcal{T}$ have an order and are reachable by moving
        By replacing the $i$-th component by one of the free first-order variables and check all reachable state
        tuples, we move over the

        \item In case of $\Phi = \exists (X \colon \tau).\,\Psi$ it follows that $\mathcal{T}, \eta \models \Phi$ iff
        there exists $\mathcal{X} \in D_\tau(Q)$ with $\mathcal{T}, \eta[X \rightarrow \mathcal {X}] \models \Psi$.
        By induction hypothesis it follows that $(\eta(x_1), \dots, \eta(x_{f}), q_0, \dots, q_0, q_1, \dots, q_r) \in
        \llbracket F(\Psi) \rrbracket^{\eta_V}_\mathcal{T}$ iff $\mathcal{T}, \eta[X
        \rightarrow \mathcal {X}] \models \Psi$. By Lemma~\ref{lemma:existential_quantifier_higher} the formula
        $\exists^\tau X.\, \Psi(X)$ iterates through all elements of $D_\tau(Q)$ and checks if one fulfills $\Psi(X)$
        by returning $Q^d$.
        With $F(\Phi) = \exists^\tau X.\, F(\Psi)(X)$ it holds \[(\eta(x_1), \dots, \eta(x_{q}), q_0, \dots, q_0, q_1, \dots, q_r) \in
        \llbracket F(\Phi) \rrbracket^{\eta_V}_\mathcal{T}.\]

        \item In case of $\Phi = [LFP\,\Psi(X, x_{i_1}, \dots, x_{i_n})](v_{j_1}, \dots, v_{j_n})$, where $X$ is a
        free variable in $\Psi$ of HO type $(\odot, \dots, \odot)$ and $x_{i_1}, \dots, x_{i_n}$ are free first-order
        variables of $\Psi$ and $v_{j_1}, \dots, v_{j_n}$ are first-order variables of $\Phi$, then it follows that
        $\mathcal{T}, \eta \models \Phi$ exactly then if $(\eta(v_{j_1}), \dots, \eta(v_{j_n})) \in LFP
        (F_\Psi^\mathcal{T})$. By definition of LFP $(\eta(v_{j_1}), \dots, \eta(v_{j_n})) \in
        LFP(F_\Psi^\mathcal{T})$ iff $X = F_\Psi^\mathcal{T}(X)$ and $(\eta(v_{j_1}), \dots, \eta(v_{j_n})) \in
        F_\Psi^\mathcal{T}(X)$. By definition of $F_\Psi^\mathcal{T}(X)$ it holds $(\eta
        (v_{j_1}), \dots, \eta(v_{j_n})) \in F_\Psi^\mathcal{T}(X)$ exactly then if $\mathcal{T}, \eta \models \Psi
        (\eta(X), \eta(v_{j_1}), \dots,$ $ \eta(v_{j_n}))$. By induction hypothesis
        \[(\eta(v_{j_1}), \dots, \eta(v_{j_n}), \eta(x_{n+1}), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \in \llbracket
        F(\Psi) \rrbracket^{\eta_V}_\mathcal{T}.\]
        Because of construction of variable mapping $V$ and $(\eta(v_{j_1}), \dots, \eta(v_{j_n})) \in \eta(X)$ the
        tuple $(\eta(v_{j_1}), \dots, \eta(v_{j_n}), \eta(x_{n+1}), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, $ $q_r)$ is also in $V
        (\eta)(X)$. By definition of the least fixpoint operator in PHFL this set $X$ is reached if it includes all
        elements of $\llbracket F(\Psi) \rrbracket^{\eta_V}_\mathcal{T}$. Because of
        construction of $F_\Psi^\mathcal{T}(X)$ and $X = F_\Psi^\mathcal{T}(X)$ it holds that $(\eta(v_{j_1}),
        \dots, \eta(v_{j_n})) \in X$ iff
        \[(\eta(v_{j_1}), \dots, \eta(v_{j_n}), \eta(x_{n+1}), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \in \llbracket
         F(\Psi) \rrbracket^{\eta_V}_\mathcal{T}.\]
        Because $X$ is the least fixpoint of $F_\Psi^\mathcal{T}$ the resulting set $X'$ is the smallest set that
        fulfills $X' \subseteq X$ and so
        \begin{align*}
        (\eta(v_{j_1}), &\dots, \eta(v_{j_n}), \eta(x_{n+1}), \dots, \eta(x_q), \\&q_0, \dots, q_0, q_1, \dots, q_r) \in \llbracket
         \mu(X\colon \bullet).\,F(\Psi) \rrbracket^{\eta_V}_\mathcal{T}.
         \end{align*}
        Because the components $j_1, \dots, j_n$ for first-order variables $v_{j_1}, \dots, v_{j_n}$ have not to be $1,
        \dots, n$ respectively, we first move them to this components and check then the least fixpoint operator.
        So it holds with $F(\Phi) = \{j_1, \dots, j_n, n+1, \dots, d\} \mu (X).\, F(\Psi)$ and
        function $g: \{1, \dots, n\} $ $\rightarrow \{j_1, \dots, j_n\}$ that
        \begin{align*}
            (\eta(x_1),& \dots, \eta(v_{g(1)-1}), \eta(v_{g(1)}), \eta(v_{g(1)+1}), \dots \eta(v_{g(2)-1}), \eta
            (v_{g(2)}),\\& \eta(v_{g(2)+1}), \dots, \eta(v_{g(n)-1}), \eta(v_{g(n)}), \eta(v_{g(n)+1}), \dots, \eta
            (x_q),\\& q_0, \dots, q_0, q_1, \dots, q_r) \in \llbracket  F(\Phi) \rrbracket^{\eta_V
            }_\mathcal{T}
        \end{align*}
        exactly then if $\mathcal{T}, \eta \vdash \Phi$.

        \item In case of $\Phi = [LFP\,\Psi(X, X_1, \dots, X_n)](V_1, \dots, V_n)$, where $X$ is a
        free variable in $\Psi$ of HO type $(\tau, \dots, \tau)$ and $X_1, \dots, X_n$ are free first-order
        variables of $\Psi$ of type $\tau$ and $V_1, \dots, V_n$ are free variables of $\Phi$ also of type $\tau$, then
        it follows that $\mathcal{T}, \eta \vdash \Phi$ exactly then if $(\eta(X_1), \dots, \eta(X_n) \in LFP
        (F_\Psi^\mathcal{T})$. By definition of LFP $(\eta(V_1), \dots, \eta(V_n)) \in
        LFP(F_\Psi^\mathcal{T})$ iff $X = F_\Psi^\mathcal{T}(X)$ and $(\eta(V_1), \dots, \eta(V_n)) \in
        F_\Psi^\mathcal{T}(X)$. By definition of $F_\Psi^\mathcal{T}(X)$ it holds $(\eta
        (V_1), \dots, \eta(V_n)) \in F_\Psi^\mathcal{T}(X)$ exactly then if $\mathcal{T}, \eta \models \Psi
        (\eta(X), $ $\eta(V_1), \dots, \eta(V_n))$. By induction hypothesis
        \[(\eta(x_1), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \in \llbracket  F(\Psi)
        \rrbracket^{\eta_V}_\mathcal{T}.\]
        Because of construction of variable mapping $\eta_V$ and $(\eta(V_1), \dots, \eta(V_n)) \in \eta(X)$ it holds
        $(\dotsb(\eta_V(X)(\eta_V(V_1))) \dotsb )(\eta_V(V_n)) = Q^d$
        and so 
        \begin{align*}
        (\eta(x_1),& \dots, \eta(x_q), q_0, \dots, q_0, \\&q_1, \dots, q_r) \in (\dotsb (\eta_V(X)(\eta_V(V_1))) \dotsb )(\eta_V(V_n)).\end{align*} By definition of the least fixpoint operator in PHFL this function
        $\eta_V(X)$ is reached if it includes all
        elements of $\llbracket  F(\Psi) \rrbracket^{\eta_V}_\mathcal{T}$. Because of
        construction of $F_\Psi^\mathcal{T}(X)$ and $X = F_\Psi^\mathcal{T}(X)$ it holds that $(\eta(V_{1}),
        \dots, \eta(V_{n})) \in X$ iff
        \[(\eta(x_1), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \in \llbracket
         F(\Psi) \rrbracket^{\eta_V}_\mathcal{T}.\]
        Because $X$ is the least fixpoint of $F_\Psi^\mathcal{T}$ the resulting set $X'$ is the smallest set that
        fulfills $X' \subseteq X$ and so
        \[(\eta(x_{1}), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \in \llbracket
         \mu(X\colon \bullet).\,F(\Psi) \rrbracket^{\eta_V}_\mathcal{T}.\]
        With $F(\Phi) = (\dotsb (\mu (X \colon T(\tau)).\,\Phi(X, X_1, \dots, X_n))(V_1))\dotsb)(V_n)$ it follows
        \[(\eta(x_{1}), \dots, \eta(x_q), q_0, \dots, q_0, q_1, \dots, q_r) \in \llbracket
         F(\Phi) \rrbracket^{\eta_V}_\mathcal{T}.\]
        exactly then if $\mathcal{T}, \eta \models \Phi$.
    \end{compactitem}
\end{proof}

The combination of Lemma~\ref{lemma:ho_lfp_equals_phfl}, Theorem~\ref{theorem:hoLfpEqualsExptime} and
Theorem~\ref{theorem:phfl_k_in_k_exptime} proves the following theorem.

\begin{theorem}
    Let $k \geq 0$. PHFL$^k$ captures \exptime{$k$} over labeled transition systems.
\end{theorem}

